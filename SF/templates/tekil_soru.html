{% extends "layout.html" %}
{% block content %}
<style>
    /* âœ… YENÄ°LENMÄ°Åž: Ã‡izim araÃ§larÄ± stilleri - soru_cozum.html ile aynÄ± */
    .drawing-fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 9998;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .drawing-fab:hover {
        background: #0056b3;
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.5);
    }

    .drawing-fab.active {
        background: #28a745;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
        50% { box-shadow: 0 4px 25px rgba(40, 167, 69, 0.6); }
        100% { box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
    }

    /* âœ… YENÄ°LENMÄ°Åž: Canvas overlay - Filtre yok */
    .drawing-section {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        transition: all 0.3s ease;
        background: transparent; /* âœ… Filtre kaldÄ±rÄ±ldÄ± */
    }

    #drawingCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        background: transparent;
    }

    #drawingCanvas.active {
        pointer-events: auto;
        cursor: crosshair;
    }

    #drawingCanvas.active.draw-mode {
        cursor: crosshair;
    }
    
    #drawingCanvas.active.erase-mode {
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="rgba(255,0,0,0.3)" stroke="red" stroke-width="2"/></svg>') 10 10, auto;
    }

    /* âœ… YENÄ°LENMÄ°Åž: AraÃ§ Ã§ubuÄŸu - SaÄŸ alt kÃ¶ÅŸe */
    .drawing-tools {
        position: fixed;
        bottom: 100px;
        right: 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.15);
        padding: 20px;
        z-index: 10000;
        width: 250px;
        max-height: 70vh;
        overflow-y: auto;
        transform: translateY(20px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .drawing-tools.show {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
    }

    /* âœ… YENÄ°: Ã‡izim durumu gÃ¶stergesi - Ãœst orta */
    .drawing-status {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10001;
        transition: all 0.3s ease;
        opacity: 0;
        visibility: hidden;
    }

    .drawing-status.show {
        opacity: 1;
        visibility: visible;
    }
    
    /* âœ… HÄ±zlÄ± renk butonlarÄ± */
    .color-quick-btn {
        width: 30px;
        height: 30px;
        border: 2px solid #dee2e6;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
        margin: 2px;
    }
    
    .color-quick-btn:hover,
    .color-quick-btn.active {
        border-color: #007bff;
        transform: scale(1.2);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    /* âœ… YENÄ°: Soru gÃ¶rsel container - soru_cozum.html ile aynÄ± boyutlar */
    .question-image-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 50vh;
        overflow-y: auto;
        margin-bottom: 1rem;
    }
    
    .question-image-container img {
        max-height: 100%;
        object-fit: contain;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    /* âœ… Responsive dÃ¼zenleme */
    @media (max-width: 768px) {
        .drawing-fab {
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }

        .drawing-tools {
            width: calc(100% - 40px);
            right: 20px;
            bottom: 80px;
        }
        
        .drawing-status {
            top: 10px;
            font-size: 0.85rem;
        }

        .question-image-container {
            height: 60vh;
        }
    }
</style>

<div class="container py-4">
    <!-- Soru KartÄ± -->
    <div class="card mb-4">
        <div class="card-body">
            <!-- âœ… YENÄ°LENMÄ°Åž: Soru Resmi - Referans kodu ile -->
            {% if soru.soru_resim %}
            <div class="question-image-container position-relative">
                <img src="{{ url_for('static', filename='soru_uploads/' + soru.soru_resim) }}" 
                     class="img-fluid rounded" 
                     alt="Soru Resmi">
                <!-- Referans kodu saÄŸ alt kÃ¶ÅŸe - KOPYALANABÄ°LÄ°R -->
                <span id="refCode-single" 
                      style="
                          position: absolute;
                          right: 10px;
                          bottom: 10px;
                          font-size: 0.85rem;
                          color: #888;
                          background: rgba(255,255,255,0.7);
                          padding: 2px 8px;
                          border-radius: 8px;
                          pointer-events: auto;
                          cursor: pointer;
                          transition: all 0.2s;
                      "
                      title="TÄ±klayarak kopyala">
                    Ref: {{ soru.reference_code }}
                </span>
            </div>
            {% endif %}

            <!-- DoÄŸru Cevap -->
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">DoÄŸru Cevap</h5>
                    <h2 class="mb-0">{{ soru.cevap }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Geri DÃ¶nÃ¼ÅŸ Butonu -->
    <div class="text-center">
        <a href="{{ url_for('home') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Ana Sayfaya DÃ¶n
        </a>
    </div>
</div>

<!-- âœ… YENÄ°: Yuvarlak Ã‡izim Butonu (FAB) - Bootstrap Icons -->
<button id="drawingToolsToggle" class="drawing-fab" title="Ã‡izim AraÃ§larÄ±">
    <i class="bi bi-pencil-fill"></i>
</button>

<!-- âœ… YENÄ°LENMÄ°Åž: Ã‡izim AraÃ§larÄ± Overlay -->
<div id="drawing-section" class="drawing-section d-none">
    <canvas id="drawingCanvas"></canvas>
    
    <!-- Ã‡izim durumu gÃ¶stergesi -->
    <div class="drawing-status" id="drawingStatus">
        <span class="badge bg-primary">Ã‡izim Modu: KapalÄ±</span>
    </div>
    
    <!-- âœ… YENÄ°LENMÄ°Åž: SaÄŸ alt araÃ§ Ã§ubuÄŸu - Bootstrap Icons -->
    <div class="drawing-tools" id="drawingTools">
        <div class="tools-header d-flex justify-content-between align-items-center mb-3">
            <span class="fw-bold text-primary">
                <i class="bi bi-palette-fill"></i> Ã‡izim AraÃ§larÄ±
            </span>
            <button class="btn btn-sm btn-outline-secondary" id="closeDrawing" title="Kapat">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="tools-content">
            <!-- Ã‡izim ModlarÄ± -->
            <div class="mb-3">
                <label class="form-label small fw-bold">Mod</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="drawingMode" id="drawMode" checked>
                    <label class="btn btn-outline-primary btn-sm" for="drawMode">
                        <i class="bi bi-pencil"></i> Ã‡iz
                    </label>
                    
                    <input type="radio" class="btn-check" name="drawingMode" id="eraseMode">
                    <label class="btn btn-outline-danger btn-sm" for="eraseMode">
                        <i class="bi bi-eraser"></i> Sil
                    </label>
                </div>
            </div>
            
            <!-- HÄ±zlÄ± Ä°ÅŸlemler -->
            <div class="mb-3">
                <label class="form-label small fw-bold">Ä°ÅŸlemler</label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-info btn-sm" id="undoCanvas" title="Geri Al">
                        <i class="bi bi-arrow-counterclockwise"></i> Geri Al
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" id="clearCanvas" title="Temizle">
                        <i class="bi bi-trash"></i> Temizle
                    </button>
                </div>
            </div>
            
            <!-- Renk Paleti -->
            <div class="mb-3">
                <label class="form-label small fw-bold">Renk SeÃ§imi</label>
                <div class="d-flex justify-content-center flex-wrap mb-2" style="gap: 4px;">
                    <button type="button" class="color-quick-btn active" data-color="#000000" style="background: #000000;" title="Siyah"></button>
                    <button type="button" class="color-quick-btn" data-color="#dc3545" style="background: #dc3545;" title="KÄ±rmÄ±zÄ±"></button>
                    <button type="button" class="color-quick-btn" data-color="#28a745" style="background: #28a745;" title="YeÅŸil"></button>
                    <button type="button" class="color-quick-btn" data-color="#007bff" style="background: #007bff;" title="Mavi"></button>
                    <button type="button" class="color-quick-btn" data-color="#ffc107" style="background: #ffc107;" title="SarÄ±"></button>
                    <button type="button" class="color-quick-btn" data-color="#6f42c1" style="background: #6f42c1;" title="Mor"></button>
                </div>
                <input type="color" id="colorPicker" value="#000000" class="form-control form-control-sm">
            </div>
            
            <!-- FÄ±rÃ§a KalÄ±nlÄ±ÄŸÄ± -->
            <div class="mb-3">
                <label class="form-label small fw-bold">
                    KalÄ±nlÄ±k: <span id="brushSizeDisplay">3</span>px
                </label>
                <input type="range" id="brushSize" min="1" max="20" value="3" class="form-range mb-2">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm quick-size" data-size="2">Ä°nce</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm quick-size active" data-size="3">Normal</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm quick-size" data-size="6">KalÄ±n</button>
                </div>
            </div>
            
            <!-- KÄ±sayollar -->
            <div class="text-center">
                <small class="text-muted">
                    <i class="bi bi-keyboard"></i> <strong>KÄ±sayollar:</strong><br>
                    <code>D</code>: Ã‡izim | <code>E</code>: Silgi<br>
                    <code>ESC</code>: Kapat | <code>Ctrl+Z</code>: Geri Al
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // âœ… YENÄ°LENMÄ°Åž: Modern Ã§izim araÃ§larÄ± - soru_cozum.html ile aynÄ±
    const drawingTools = {
        canvas: null,
        ctx: null,
        isDrawing: false,
        isDrawingMode: false,
        isEraser: false,
        brushSize: 3,
        brushColor: '#000000',
        undoStack: [],

        init() {
            this.canvas = document.getElementById('drawingCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.addEventListeners();
            this.resizeCanvas();
            this.saveState();
        },

        saveState() {
            this.undoStack.push(this.canvas.toDataURL());
            if (this.undoStack.length > 10) {
                this.undoStack.shift();
            }
        },

        undo() {
            if (this.undoStack.length > 1) {
                this.undoStack.pop();
                const previousState = this.undoStack[this.undoStack.length - 1];
                const img = new Image();
                img.onload = () => {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.drawImage(img, 0, 0);
                };
                img.src = previousState;
            }
        },

        clearCanvas() {
            if (confirm('TÃ¼m Ã§izimleri temizlemek istediÄŸinizden emin misiniz?')) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.saveState();
            }
        },

        // âœ… YENÄ°LENMÄ°Åž: Toggle fonksiyonu
        toggleToolsVisibility() {
            const section = document.getElementById('drawing-section');
            const toolsPanel = document.getElementById('drawingTools');
            const statusPanel = document.getElementById('drawingStatus');
            const fabBtn = document.getElementById('drawingToolsToggle');
            
            const isHidden = section.classList.contains('d-none');
            
            if (isHidden) {
                // AÃ§
                section.classList.remove('d-none');
                setTimeout(() => {
                    toolsPanel.classList.add('show');
                    statusPanel.classList.add('show');
                }, 50);
                fabBtn.classList.add('active');
                
                if (!this.isDrawingMode) {
                    this.toggleDrawing();
                }
            } else {
                // Kapat
                toolsPanel.classList.remove('show');
                statusPanel.classList.remove('show');
                setTimeout(() => {
                    section.classList.add('d-none');
                }, 300);
                fabBtn.classList.remove('active');
                
                if (this.isDrawingMode) {
                    this.toggleDrawing();
                }
            }
        },

        // âœ… YENÄ°LENMÄ°Åž: Status gÃ¼ncellemesi - Bootstrap Icons
        updateStatus() {
            const statusElement = document.getElementById('drawingStatus');
            if (statusElement) {
                const mode = this.isDrawingMode ? (this.isEraser ? 'Silgi' : 'Ã‡izim') : 'HazÄ±r';
                const colorClass = this.isDrawingMode ? (this.isEraser ? 'bg-danger' : 'bg-success') : 'bg-info';
                const iconClass = this.isEraser ? 'bi-eraser' : 'bi-pencil-fill';
                statusElement.innerHTML = `<span class="badge ${colorClass}">
                    <i class="bi ${iconClass}"></i> 
                    ${mode}
                </span>`;
            }
        },

        startDrawing(e) {
            if (!this.isDrawingMode) return;
            this.isDrawing = true;
            this.ctx.beginPath();
            this.ctx.moveTo(e.clientX, e.clientY);
        },

        draw(e) {
            if (!this.isDrawing || !this.isDrawingMode) return;
            
            this.ctx.lineWidth = this.brushSize;
            this.ctx.lineCap = 'round';
            this.ctx.lineJoin = 'round';
            
            if (this.isEraser) {
                this.ctx.globalCompositeOperation = 'destination-out';
            } else {
                this.ctx.globalCompositeOperation = 'source-over';
                this.ctx.strokeStyle = this.brushColor;
            }
            
            this.ctx.lineTo(e.clientX, e.clientY);
            this.ctx.stroke();
            this.ctx.beginPath();
            this.ctx.moveTo(e.clientX, e.clientY);
        },

        stopDrawing() {
            if (this.isDrawing) {
                this.isDrawing = false;
                this.ctx.beginPath();
                this.saveState();
            }
        },

        toggleDrawing() {
            this.isDrawingMode = !this.isDrawingMode;
            this.canvas.classList.toggle('active', this.isDrawingMode);
            this.canvas.classList.toggle('draw-mode', this.isDrawingMode && !this.isEraser);
            this.canvas.classList.toggle('erase-mode', this.isDrawingMode && this.isEraser);
            this.updateStatus();
        },

        setEraseMode(isEraser) {
            this.isEraser = isEraser;
            this.canvas.classList.toggle('draw-mode', this.isDrawingMode && !this.isEraser);
            this.canvas.classList.toggle('erase-mode', this.isDrawingMode && this.isEraser);
            this.updateStatus();
        },

        addEventListeners() {
            // Canvas olaylarÄ±
            this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
            this.canvas.addEventListener('mousemove', (e) => this.draw(e));
            this.canvas.addEventListener('mouseup', () => this.stopDrawing());
            this.canvas.addEventListener('mouseout', () => this.stopDrawing());

            // Touch events (mobil)
            this.canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const rect = this.canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.canvas.dispatchEvent(mouseEvent);
            });

            this.canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const rect = this.canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.canvas.dispatchEvent(mouseEvent);
            });

            this.canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                this.canvas.dispatchEvent(mouseEvent);
            });

            // AraÃ§ butonlarÄ±
            document.getElementById('drawingToolsToggle').addEventListener('click', () => this.toggleToolsVisibility());
            document.getElementById('closeDrawing').addEventListener('click', () => this.toggleToolsVisibility());
            document.getElementById('clearCanvas').addEventListener('click', () => this.clearCanvas());
            document.getElementById('undoCanvas').addEventListener('click', () => this.undo());

            // Ã‡izim modu radio butonlarÄ±
            document.getElementById('drawMode').addEventListener('change', () => this.setEraseMode(false));
            document.getElementById('eraseMode').addEventListener('change', () => this.setEraseMode(true));

            // Renk ve araÃ§lar
            document.getElementById('colorPicker').addEventListener('input', (e) => this.updateColor(e.target.value));
            document.getElementById('brushSize').addEventListener('input', (e) => this.updateBrushSize(e.target.value));

            // HÄ±zlÄ± renk butonlarÄ±
            document.querySelectorAll('.color-quick-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const color = e.target.dataset.color;
                    this.updateColor(color);
                    document.getElementById('colorPicker').value = color;
                    
                    document.querySelectorAll('.color-quick-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            // HÄ±zlÄ± kalÄ±nlÄ±k butonlarÄ±
            document.querySelectorAll('.quick-size').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const size = e.target.dataset.size;
                    this.updateBrushSize(size);
                    document.getElementById('brushSize').value = size;
                    
                    document.querySelectorAll('.quick-size').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            // Klavye kÄ±sayollarÄ±
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    this.undo();
                    return;
                }
                
                switch(e.key.toLowerCase()) {
                    case 'd':
                        if (document.getElementById('drawing-section').classList.contains('d-none')) {
                            this.toggleToolsVisibility();
                        }
                        if (!this.isDrawingMode) this.toggleDrawing();
                        document.getElementById('drawMode').checked = true;
                        this.setEraseMode(false);
                        break;
                    case 'e':
                        if (this.isDrawingMode) {
                            document.getElementById('eraseMode').checked = true;
                            this.setEraseMode(true);
                        }
                        break;
                    case 'escape':
                        if (!document.getElementById('drawing-section').classList.contains('d-none')) {
                            this.toggleToolsVisibility();
                        }
                        break;
                }
            });
        },

        updateColor(color) {
            this.brushColor = color;
        },

        updateBrushSize(size) {
            this.brushSize = parseInt(size, 10);
            document.getElementById('brushSizeDisplay').textContent = size;
        },

        resizeCanvas() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
        }
    };

    // Sayfa yÃ¼klendiÄŸinde
    document.addEventListener("DOMContentLoaded", function() {
        // Ã‡izim araÃ§larÄ± baÅŸlangÄ±Ã§
        drawingTools.init();
        
        // Pencere boyutu deÄŸiÅŸtiÄŸinde
        window.addEventListener('resize', () => drawingTools.resizeCanvas());
        
        // âœ… YENÄ°: Referans kodu kopyalama iÅŸlevi
        const refCodeSpan = document.getElementById('refCode-single');
        if (refCodeSpan) {
            refCodeSpan.addEventListener('click', async function() {
                const code = this.textContent.replace('Ref: ', '').trim();
                
                try {
                    // Modern kopyalama API'si
                    await navigator.clipboard.writeText(code);
                    
                    // GÃ¶rsel geri bildirim
                    const originalText = this.textContent;
                    const originalColor = this.style.color;
                    
                    this.textContent = 'âœ… KopyalandÄ±!';
                    this.style.color = '#28a745';
                    this.style.background = 'rgba(40, 167, 69, 0.8)';
                    
                    // 1 saniye sonra geri dÃ¶n
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.style.color = originalColor;
                        this.style.background = 'rgba(255,255,255,0.7)';
                    }, 1000);
                    
                    console.log(`Referans kodu kopyalandÄ±: ${code}`);
                    
                } catch (err) {
                    console.error('Kopyalama baÅŸarÄ±sÄ±z:', err);
                    
                    // Fallback: Eski yÃ¶ntem
                    const textArea = document.createElement('textarea');
                    textArea.value = code;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    // Fallback geri bildirimi
                    const originalText = this.textContent;
                    this.textContent = 'ðŸ“‹ KopyalandÄ±!';
                    this.style.color = '#ffc107';
                    
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.style.color = '#888';
                    }, 1000);
                }
            });
            
            // Hover efekti
            refCodeSpan.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(255,255,255,0.9)';
                this.style.color = '#495057';
            });
            
            refCodeSpan.addEventListener('mouseleave', function() {
                this.style.background = 'rgba(255,255,255,0.7)';
                this.style.color = '#888';
            });
        }
    });
</script>
{% endblock %}