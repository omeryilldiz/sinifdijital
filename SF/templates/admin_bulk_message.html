{% extends "admin_layout.html" %}

{% block content %}
<div class="container py-4">
    <h3>
        <i class="bi bi-broadcast me-2"></i>
        Toplu Mesaj GÃ¶nder
    </h3>
    <hr>
    
    <form method="POST" action="{{ url_for('admin_send_bulk_message') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Mesaj Kategorisi (Tek baÅŸÄ±na) -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="message_type" class="form-label">Mesaj Kategorisi</label>
                <select class="form-select" id="message_type" name="message_type">
                    <option value="info">ğŸ“ Bilgilendirme</option>
                    <option value="warning">âš ï¸ UyarÄ±</option>
                    <option value="success">ğŸ‰ Tebrik/BaÅŸarÄ±</option>
                    <option value="urgent">ğŸš¨ Acil/Ã–nemli</option>
                    <option value="reminder">ğŸ”” HatÄ±rlatma</option>
                </select>
            </div>
        </div>
        
        <!-- SABÄ°T FÄ°LTRELER: Ä°l, Ä°lÃ§e, Okul, SÄ±nÄ±f -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label for="province_filter" class="form-label">Ä°l</label>
                <select class="form-select" id="province_filter" name="province_filter">
                    <option value="">TÃ¼mÃ¼</option>
                    {% for province in provinces %}
                        <option value="{{ province.id }}">{{ province.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="district_filter" class="form-label">Ä°lÃ§e</label>
                <select class="form-select" id="district_filter" name="district_filter">
                    <option value="">TÃ¼mÃ¼</option>
                    <!-- Ä°l seÃ§ilince JS ile doldurulacak -->
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="school_filter" class="form-label">Okul</label>
                <select class="form-select" id="school_filter" name="school_filter">
                    <option value="">TÃ¼mÃ¼</option>
                    <!-- Ä°lÃ§e seÃ§ilince JS ile doldurulacak -->
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="class_filter" class="form-label">SÄ±nÄ±f</label>
                <select class="form-select" id="class_filter" name="class_filter">
                    <option value="">TÃ¼mÃ¼</option>
                    <option value="5">5. SÄ±nÄ±f</option>
                    <option value="6">6. SÄ±nÄ±f</option>
                    <option value="7">7. SÄ±nÄ±f</option>
                    <option value="8">8. SÄ±nÄ±f</option>
                    <option value="9">9. SÄ±nÄ±f</option>
                    <option value="10">10. SÄ±nÄ±f</option>
                    <option value="11">11. SÄ±nÄ±f</option>
                    <option value="12">12. SÄ±nÄ±f</option>
                    <option value="LGS">LGS</option>
                    <option value="TYT">TYT</option>
                    <option value="AYT">AYT</option>
                </select>
            </div>
        </div>
        
        <!-- Hedef Ã–ÄŸrenci SayÄ±sÄ± (Dinamik) -->
        <div class="row mb-4">
            <div class="col-md-12">
                <span id="target-count" class="alert alert-info d-flex align-items-center" aria-live="polite">
                  SeÃ§ilen filtrelere gÃ¶re hedef Ã¶ÄŸrenci sayÄ±sÄ± hesaplanacak...
                </span>
            </div>
        </div>
        
        <!-- Mesaj BaÅŸlÄ±ÄŸÄ± -->
        <div class="row mb-4">
            <div class="col-md-8">
                <label for="subject" class="form-label">Mesaj BaÅŸlÄ±ÄŸÄ±</label>
                <input type="text" class="form-control" id="subject" name="subject" maxlength="255" required
                       placeholder="Mesaj baÅŸlÄ±ÄŸÄ±nÄ± yazÄ±nÄ±z">
            </div>
        </div>
        
        <!-- Mesaj Ä°Ã§eriÄŸi -->
        <div class="mb-3">
            <label for="content" class="form-label">Mesaj Ä°Ã§eriÄŸi</label>
            <textarea class="form-control" id="content" name="content" rows="8"
                      placeholder="Ã–ÄŸrencilere gÃ¶ndermek istediÄŸiniz mesajÄ± yazÄ±n..." maxlength="2000"></textarea>
        </div>
        
        <div class="d-flex justify-content-between">
            <a href="{{ url_for('admin_students') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i>Geri DÃ¶n
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-broadcast me-1"></i>Toplu Mesaj GÃ¶nder
            </button>
        </div>
    </form>
</div>

<script src="{{ url_for('static', filename='main.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    const el = {
        province: document.getElementById('province_filter'),
        district: document.getElementById('district_filter'),
        school:   document.getElementById('school_filter'),
        cls:      document.getElementById('class_filter'),
        target:   document.getElementById('target-count')
    };

    let debounceTimer = null;
    function debounce(fn, wait=300){
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fn, wait);
    }

    function setTargetState(type, msg){
        const map = {
            info: 'alert alert-info d-flex align-items-center',
            success: 'alert alert-success d-flex align-items-center',
            warn: 'alert alert-warning d-flex align-items-center',
            danger: 'alert alert-danger d-flex align-items-center'
        };
        el.target.className = map[type] || map.info;
        el.target.textContent = msg;
    }

    // Ä°l deÄŸiÅŸince ilÃ§eleri al
    el.province.addEventListener('change', () => {
        const pid = el.province.value;
        el.district.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
        el.school.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
        if (!pid) {
            setTargetState('info','LÃ¼tfen en az bir filtre seÃ§in...');
            requestCountUpdate();
            return;
        }
        fetch(`/get_districts/${pid}`)
          .then(r=>r.json())
          .then(data=>{
            data.forEach(d=>{
                el.district.insertAdjacentHTML('beforeend', `<option value="${d.id}">${d.name}</option>`);
            });
          })
          .catch(()=> setTargetState('danger','Ä°lÃ§eler yÃ¼klenemedi'));
        requestCountUpdate();
    });

    // Ä°lÃ§e deÄŸiÅŸince okullar (tek endpoint varsayÄ±mÄ±: /get_schools_filtered_district/<district_id>)
    el.district.addEventListener('change', () => {
        const did = el.district.value;
        el.school.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
        if (!did) {
            requestCountUpdate();
            return;
        }
        fetch(`/get_schools_filtered_district/${did}`)
          .then(r=>r.json())
          .then(data=>{
            if (!data.length){
                el.school.innerHTML = '<option value="">Bu ilÃ§ede okul bulunamadÄ±</option>';
            } else {
                data.sort((a,b)=>a.name.localeCompare(b.name))
                    .forEach(s=>{
                        el.school.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.name}</option>`);
                    });
            }
          })
          .catch(()=> setTargetState('danger','Okullar yÃ¼klenemedi'));
        requestCountUpdate();
    });

    [el.school, el.cls].forEach(sel=>{
        sel.addEventListener('change', ()=> requestCountUpdate());
    });

    function requestCountUpdate(){
        debounce(()=>{
            const filters = {
                province: el.province.value,
                district: el.district.value,
                school: el.school.value,
                class: el.cls.value
            };
            if (!filters.province && !filters.district && !filters.school && !filters.class){
                setTargetState('info','LÃ¼tfen en az bir filtre seÃ§in...');
                return;
            }
            setTargetState('info','HesaplanÄ±yor...');
            fetch('/get_target_count', {
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify(filters)
            })
            .then(r=>r.json())
            .then(data=>{
                if (data.success){
                    setTargetState('success', data.message);
                } else {
                    setTargetState('warn', data.message);
                }
            })
            .catch(()=>{
                setTargetState('danger','Hesaplama sÄ±rasÄ±nda hata oluÅŸtu');
            });
        }, 300);
    }

    // Form submit Ã¶ncesi kÄ±sa validasyon (Ã¶rn. mesaj iÃ§eriÄŸi minimum uzunluk)
    const form = document.querySelector('form[action="{{ url_for("admin_send_bulk_message") }}"]');
    if (form){
        form.addEventListener('submit', (e)=>{
            const subject = form.querySelector('#subject').value.trim();
            const rawContent = document.querySelector('#content').value.trim();
            if (subject.length < 3){
                e.preventDefault();
                alert('BaÅŸlÄ±k en az 3 karakter olmalÄ±.');
                return;
            }
            if (rawContent.length < 5){
                e.preventDefault();
                alert('Mesaj iÃ§eriÄŸi Ã§ok kÄ±sa.');
                return;
            }

        });
    }
});
</script>
{% endblock %}