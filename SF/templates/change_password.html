{% extends "dashboard_layout.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-lock me-2"></i>Şifre Değiştir
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Flash mesajları -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <!-- Şifre gereksinimleri bilgisi -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Şifre Gereksinimleri</h6>
                        <ul class="mb-0 small">
                            <li>En az 8 karakter</li>
                            <li>En az 1 büyük harf (A-Z)</li>
                            <li>En az 1 küçük harf (a-z)</li>
                            <li>En az 1 rakam (0-9)</li>
                            <li>En az 1 özel karakter (!@#$%^&*)</li>
                        </ul>
                    </div>
                    
                    <form method="POST" action="{{ url_for('change_password') }}">
                        {{ form.hidden_tag() }}
                        
                        <!-- Mevcut Şifre -->
                        <div class="mb-3">
                            <label for="current_password" class="form-label">
                                <i class="bi bi-key me-1"></i>Mevcut Şifre
                            </label>
                            <div class="input-group">
                                {{ form.current_password(class="form-control", id="current_password", placeholder="Mevcut şifrenizi girin") }}
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('current_password')">
                                    <i class="bi bi-eye" id="current_password_icon"></i>
                                </button>
                            </div>
                            {% if form.current_password.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.current_password.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Yeni Şifre -->
                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                <i class="bi bi-lock me-1"></i>Yeni Şifre
                            </label>
                            <div class="input-group">
                                {{ form.new_password(class="form-control", id="new_password", placeholder="Yeni şifrenizi girin") }}
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_password')">
                                    <i class="bi bi-eye" id="new_password_icon"></i>
                                </button>
                            </div>
                            {% if form.new_password.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.new_password.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <!-- Şifre gücü göstergesi -->
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar" id="password-strength-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="password-strength-text"></small>
                        </div>
                        
                        <!-- Şifre Tekrar -->
                        <div class="mb-4">
                            <label for="confirm_password" class="form-label">
                                <i class="bi bi-lock-fill me-1"></i>Yeni Şifre Tekrar
                            </label>
                            <div class="input-group">
                                {{ form.confirm_password(class="form-control", id="confirm_password", placeholder="Yeni şifrenizi tekrar girin") }}
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password')">
                                    <i class="bi bi-eye" id="confirm_password_icon"></i>
                                </button>
                            </div>
                            {% if form.confirm_password.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.confirm_password.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="text-muted" id="password-match-text"></small>
                        </div>
                        
                        <!-- Butonlar -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-2"></i>Şifreyi Değiştir
                            </button>
                            <a href="{{ url_for('profile') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Geri Dön
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Şifre göster/gizle
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Şifre gücü kontrolü
document.getElementById('new_password').addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    
    let strength = 0;
    let feedback = [];
    
    if (password.length >= 8) strength += 20;
    else feedback.push('8+ karakter');
    
    if (/[A-Z]/.test(password)) strength += 20;
    else feedback.push('büyük harf');
    
    if (/[a-z]/.test(password)) strength += 20;
    else feedback.push('küçük harf');
    
    if (/\d/.test(password)) strength += 20;
    else feedback.push('rakam');
    
    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 20;
    else feedback.push('özel karakter');
    
    strengthBar.style.width = strength + '%';
    
    if (strength <= 20) {
        strengthBar.className = 'progress-bar bg-danger';
        strengthText.textContent = 'Çok zayıf - Eksik: ' + feedback.join(', ');
        strengthText.className = 'text-danger small';
    } else if (strength <= 40) {
        strengthBar.className = 'progress-bar bg-warning';
        strengthText.textContent = 'Zayıf - Eksik: ' + feedback.join(', ');
        strengthText.className = 'text-warning small';
    } else if (strength <= 60) {
        strengthBar.className = 'progress-bar bg-info';
        strengthText.textContent = 'Orta - Eksik: ' + feedback.join(', ');
        strengthText.className = 'text-info small';
    } else if (strength <= 80) {
        strengthBar.className = 'progress-bar bg-primary';
        strengthText.textContent = 'İyi - Eksik: ' + feedback.join(', ');
        strengthText.className = 'text-primary small';
    } else {
        strengthBar.className = 'progress-bar bg-success';
        strengthText.textContent = 'Güçlü şifre ✓';
        strengthText.className = 'text-success small';
    }
});

// Şifre eşleşme kontrolü
document.getElementById('confirm_password').addEventListener('input', function() {
    const password = document.getElementById('new_password').value;
    const confirm = this.value;
    const matchText = document.getElementById('password-match-text');
    
    if (confirm === '') {
        matchText.textContent = '';
    } else if (password === confirm) {
        matchText.textContent = '✓ Şifreler eşleşiyor';
        matchText.className = 'text-success small';
    } else {
        matchText.textContent = '✗ Şifreler eşleşmiyor';
        matchText.className = 'text-danger small';
    }
});
</script>
{% endblock %}