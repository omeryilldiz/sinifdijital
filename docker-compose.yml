services:
  web:
    image: sf-web:latest
    build: .
    environment:
      # Database configuration
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_USER: sfuser
      POSTGRES_DB: sfdb
      # Redis configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      # Server configuration
      SERVER_NAME: www.sinifdijital.com
      PREFERRED_URL_SCHEME: https
      GUNICORN_WORKERS: '1'
      # Admin Panel Security
      ADMIN_URL_PREFIX: '/yonetim-panel-x9k2m'
      EMERGENCY_RECOVERY_PASSWORD: 'ultra-secret-recovery-key-2026-sf'
    # Secrets (e.g. SECRET_KEY) should be provided via Docker Secrets in production.
    # Web will load secrets from /run/secrets/ via the image entrypoint.
    secrets:
      - secret_key
      - postgres_password
      - mail_password
      - google_client_secret_v2
      - google_client_id_v2
      - redis_password
    # Don't override command - let ENTRYPOINT (/app/docker/docker-entrypoint.sh) run first
    command: ["gunicorn", "-c", "gunicorn_config.py", "wsgi:app"]
    ports:
      - "5000:5000"
    volumes:
      - ./SF/templates:/app/SF/templates
      - ./SF/static:/app/SF/static
      - ./SF/static/uploads:/app/SF/static/uploads
      - ./SF/static/soru_uploads:/app/SF/static/soru_uploads
      - ./SF/static/video_uploads:/app/SF/static/video_uploads
      - ./SF/static/cozum_uploads:/app/SF/static/cozum_uploads
      - ./SF/static/pdf_uploads:/app/SF/static/pdf_uploads
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    restart: always
    networks:
      - sf-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,sys; urllib.request.urlopen('http://127.0.0.1:5000/health');\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'

  nginx:
    image: nginx:1.25-alpine
    # container_name: sf-nginx  # Removed for Swarm compatibility
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # upstreams.conf removed - upstream already defined in nginx-sf.conf
      - ./deploy/nginx-sf.conf:/etc/nginx/conf.d/default.conf:ro
      - ./SF/static:/app/SF/static:ro
      - /var/www/letsencrypt:/var/www/letsencrypt:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - web
      # web:
      #   condition: service_healthy  # Geçici olarak devre dışı
    restart: always
    networks:
      - sf-net
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: sfdb
      POSTGRES_USER: sfuser
    secrets:
      - postgres_password
    volumes:
      - sf-db-data:/var/lib/postgresql/data
    restart: always
    networks:
      - sf-net
    entrypoint: ["/bin/sh","-c","export POSTGRES_PASSWORD=$$(cat /run/secrets/postgres_password) && exec docker-entrypoint.sh postgres"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sfuser -d sfdb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    restart: always
    secrets:
      - redis_password
    command: ["/bin/sh","-c","redis-server --requirepass $$(cat /run/secrets/redis_password)"]
    networks:
      - sf-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$$(cat /run/secrets/redis_password)", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  sf-db-data:

networks:
  sf-net:
    driver: bridge

secrets:
  secret_key:
    file: ./deploy/secrets/secret_key.txt
  postgres_password:
    file: ./deploy/secrets/postgres_password.txt
  redis_password:
    file: ./deploy/secrets/redis_password.txt
  mail_password:
    file: ./deploy/secrets/mail_password.txt
  google_client_secret:
    file: ./deploy/secrets/google_client_secret.txt
  google_client_secret_v2:
    file: ./deploy/secrets/google_client_secret.txt
  google_client_id_v2:
    file: ./deploy/secrets/google_client_id.txt
